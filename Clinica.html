<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Facturación - Clínica</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      letter-spacing: -0.01em;
    }
    
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f8f9fa;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #8347be;
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #6d38a0;
    }
    
    .card-professional {
      background: #ffffff;
      border: 1px solid #e1e4e8;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    }
    
    .app-background {
      background: #f5f7fa;
    }
    
    .btn-primary-pro {
      background: #8347be;
      transition: all 0.15s ease;
      font-weight: 500;
      letter-spacing: 0.01em;
    }
    
    .btn-primary-pro:hover {
      background: #6d38a0;
      box-shadow: 0 2px 4px rgba(131, 71, 190, 0.2);
    }
    
    .btn-secondary-pro {
      background: #ffffff;
      border: 1px solid #d0d7de;
      transition: all 0.15s ease;
      font-weight: 500;
      letter-spacing: 0.01em;
    }
    
    .btn-secondary-pro:hover {
      background: #f6f8fa;
      border-color: #bdc4cc;
    }
    
    .input-pro {
      background: #ffffff;
      border: 1px solid #d0d7de;
      transition: all 0.15s ease;
      font-weight: 400;
    }
    
    .input-pro:focus {
      border-color: #8347be;
      box-shadow: 0 0 0 3px rgba(131, 71, 190, 0.08);
      outline: none;
    }
    
    .table-row-pro {
      transition: background-color 0.1s ease;
    }
    
    .table-row-pro:hover {
      background: #f6f8fa;
    }
    
    .modal-backdrop {
      background: rgba(22, 27, 34, 0.6);
      backdrop-filter: blur(2px);
    }
    
    .fade-in-pro {
      animation: fadeInPro 0.15s ease;
    }
    
    @keyframes fadeInPro {
      from { 
        opacity: 0; 
        transform: scale(0.98);
      }
      to { 
        opacity: 1; 
        transform: scale(1);
      }
    }
    
    .icon-box {
      background: #8347be;
    }
    
    .badge-pro {
      background: #8347be;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    
    .invoice-document {
      background: #ffffff;
    }
    
    @media print {
      .no-print { display: none !important; }
      .invoice-document { 
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        background: #ffffff;
      }
    }
    
    .status-paid-pro {
      background: #28a745;
    }
    
    .status-pending-pro {
      background: #ffc107;
    }
    
    .divider-pro {
      height: 1px;
      background: #e1e4e8;
    }
    
    .text-pro-primary {
      color: #1f2937;
    }
    
    .text-pro-secondary {
      color: #57606a;
    }
    
    .text-pro-tertiary {
      color: #6e7781;
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    
    .section-header {
      border-bottom: 2px solid #e1e4e8;
      padding-bottom: 12px;
      margin-bottom: 20px;
    }
    
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      opacity: 1;
    }
    
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23586069' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }
    
    .compact-btn {
      padding: 6px 12px;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .table-header-pro {
      background: #f6f8fa;
      border-bottom: 2px solid #d0d7de;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.05em;
      color: #57606a;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full app-background">
  <div id="app" class="h-full overflow-auto"><!-- Vista Principal POS -->
   <div id="pos-view" class="min-h-full p-5 md:p-7"><!-- Header -->
    <header class="card-professional rounded-md p-5 mb-5">
     <div class="flex flex-wrap items-center justify-between gap-5">
      <div class="flex items-center gap-4">
       <div class="w-12 h-12 rounded icon-box flex items-center justify-center">
        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
        </svg>
       </div>
       <div>
        <h1 id="clinic-title" class="text-xl md:text-2xl font-semibold text-pro-primary">Clínica Salud Plus</h1>
        <p class="text-xs text-pro-secondary font-medium mt-0.5">Sistema de Facturación Médica</p>
       </div>
      </div><!-- Selector de Moneda -->
      <div class="flex items-center gap-3 bg-white px-4 py-2.5 rounded border border-gray-300"><label for="currency-select" class="text-xs font-semibold text-pro-secondary uppercase tracking-wide">Moneda:</label> <select id="currency-select" class="input-pro rounded px-3 py-1.5 text-sm font-medium text-pro-primary cursor-pointer border-0"> <option value="MXN">MXN - Peso Mexicano</option> <option value="USD">USD - Dólar Estadounidense</option> <option value="EUR">EUR - Euro</option> <option value="INR">INR - Rupia India</option> <option value="GBP">GBP - Libra Esterlina</option> </select>
      </div>
     </div>
    </header>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5"><!-- Panel Izquierdo -->
     <div class="lg:col-span-1 space-y-5"><!-- Búsqueda de Productos -->
      <div class="card-professional rounded-md p-5">
       <div class="section-header">
        <h2 class="text-sm font-semibold text-pro-primary uppercase tracking-wide flex items-center gap-2">
         <svg class="w-4 h-4 text-pro-secondary" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
         </svg> Inventario de Productos</h2>
       </div>
       <div class="relative"><input type="text" id="product-search" placeholder="Buscar por código o nombre del producto..." class="input-pro w-full rounded px-4 py-2.5 pl-10 text-sm">
        <svg class="w-4 h-4 text-pro-tertiary absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
       </div>
       <div id="product-results" class="mt-3 space-y-2 max-h-64 overflow-y-auto"></div>
      </div><!-- Gestión de Clientes -->
      <div class="card-professional rounded-md p-5">
       <div class="section-header">
        <h2 class="text-sm font-semibold text-pro-primary uppercase tracking-wide flex items-center gap-2">
         <svg class="w-4 h-4 text-pro-secondary" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
         </svg> Información del Cliente</h2>
       </div><!-- Buscar Cliente -->
       <div class="mb-4"><label for="client-search" class="text-xs font-semibold text-pro-secondary uppercase tracking-wide mb-2 block">Buscar cliente existente</label>
        <div class="relative"><input type="text" id="client-search" placeholder="Nombre completo o número de DNI..." class="input-pro w-full rounded px-4 py-2.5 pl-10 text-sm">
         <svg class="w-4 h-4 text-pro-tertiary absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
         </svg>
        </div>
        <div id="client-results" class="mt-2 space-y-2 max-h-32 overflow-y-auto"></div>
       </div><!-- Cliente Seleccionado -->
       <div id="selected-client" class="hidden bg-gray-50 rounded p-3 mb-4 border border-gray-200 fade-in-pro">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-2.5">
          <div class="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center">
           <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
           </svg>
          </div>
          <div>
           <p class="font-semibold text-pro-primary text-sm" id="selected-client-name">-</p>
           <p class="text-xs text-pro-tertiary" id="selected-client-dni">DNI: -</p>
          </div>
         </div><button onclick="clearSelectedClient()" class="text-pro-tertiary hover:text-pro-primary p-1.5 hover:bg-gray-100 rounded transition-all">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg></button>
        </div>
       </div><!-- Botón Nuevo Cliente --> <button onclick="openNewClientModal()" class="btn-secondary-pro w-full py-2.5 rounded text-pro-primary text-sm font-medium flex items-center justify-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
        </svg> Registrar Nuevo Cliente </button>
      </div>
     </div><!-- Panel Derecho - Carrito -->
     <div class="lg:col-span-2">
      <div class="card-professional rounded-md p-5">
       <div class="flex items-center justify-between mb-5">
        <h2 class="text-base font-semibold text-pro-primary flex items-center gap-2">
         <svg class="w-5 h-5 text-pro-secondary" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
         </svg> Detalle de la Factura</h2><span id="currency-badge" class="badge-pro px-3 py-1 text-white rounded text-xs">MXN</span>
       </div><!-- Tabla de Productos -->
       <div class="overflow-x-auto rounded border border-gray-200">
        <table class="w-full text-sm">
         <thead>
          <tr class="table-header-pro">
           <th class="text-left py-2.5 px-3">Código</th>
           <th class="text-left py-2.5 px-3">Producto</th>
           <th class="text-left py-2.5 px-3 hidden md:table-cell">Descripción</th>
           <th class="text-center py-2.5 px-3">Cant.</th>
           <th class="text-right py-2.5 px-3">P. Unit.</th>
           <th class="text-center py-2.5 px-3 hidden lg:table-cell">Stock</th>
           <th class="text-center py-2.5 px-3">Desc. %</th>
           <th class="text-right py-2.5 px-3">Total</th>
           <th class="text-center py-2.5 px-3">Acciones</th>
          </tr>
         </thead>
         <tbody id="cart-table">
          <tr id="empty-cart-row">
           <td colspan="9" class="py-16 text-center">
            <svg class="w-14 h-14 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg><p class="text-sm font-medium text-pro-tertiary">No hay productos agregados</p><p class="text-xs text-pro-tertiary mt-1">Utilice el buscador para agregar productos a la factura</p></td>
          </tr>
         </tbody>
        </table>
       </div><!-- Totales -->
       <div class="mt-5 bg-gray-50 rounded p-4 border border-gray-200">
        <div class="flex flex-col items-end space-y-2">
         <div class="flex justify-between w-full max-w-md text-sm"><span class="text-pro-secondary font-medium">Subtotal:</span> <span id="subtotal" class="font-semibold text-pro-primary">$0.00</span>
         </div>
         <div class="flex justify-between w-full max-w-md text-sm"><span class="text-pro-secondary font-medium">Descuentos Aplicados:</span> <span id="total-discounts" class="font-semibold text-pro-primary">-$0.00</span>
         </div>
         <div class="divider-pro w-full max-w-md my-2"></div>
         <div class="flex justify-between w-full max-w-md text-lg"><span class="font-semibold text-pro-primary">TOTAL A PAGAR:</span> <span id="total" class="font-bold text-pro-primary">$0.00</span>
         </div>
        </div><button onclick="processPayment()" id="checkout-btn" class="btn-primary-pro w-full mt-4 py-3 rounded text-white font-medium text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled> <span class="flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg> Procesar Pago y Generar Factura </span> </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Vista de Factura -->
   <div id="invoice-view" class="hidden min-h-full p-4 md:p-6">
    <div class="max-w-4xl mx-auto"><!-- Botones de Acción -->
     <div class="no-print flex gap-2.5 mb-5"><button onclick="goBackToPOS()" class="btn-secondary-pro compact-btn rounded text-pro-primary font-medium flex items-center gap-1.5">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
       </svg> Volver al Sistema </button> <button onclick="window.print()" class="btn-primary-pro compact-btn rounded text-white font-medium flex items-center gap-1.5">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
       </svg> Imprimir Factura </button> <button onclick="newInvoice()" class="bg-green-600 hover:bg-green-700 compact-btn rounded text-white font-medium flex items-center gap-1.5 transition-all">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
       </svg> Nueva Factura </button>
     </div><!-- Factura -->
     <div id="invoice-content" class="invoice-document card-professional rounded-md p-8"><!-- Header Factura -->
      <div class="flex justify-between items-start mb-8 pb-6 border-b-2 border-gray-300">
       <div>
        <div class="flex items-center gap-3 mb-2">
         <div class="w-11 h-11 rounded icon-box flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
         </div>
         <div>
          <h1 id="invoice-clinic-name" class="text-xl font-semibold text-pro-primary">Clínica Salud Plus</h1>
          <p id="invoice-clinic-address" class="text-xs text-pro-secondary mt-0.5">Av. Principal #123, Ciudad</p>
         </div>
        </div>
        <p id="invoice-clinic-phone" class="text-xs text-pro-secondary">Tel: (555) 123-4567</p>
        <p id="invoice-clinic-email" class="text-xs text-pro-secondary">Email: contacto@clinicaplus.com</p>
       </div>
       <div class="text-right">
        <h2 class="text-2xl font-bold text-pro-primary mb-2 tracking-tight">FACTURA</h2>
        <p class="text-xs text-pro-secondary"><span class="font-semibold">Número:</span> <span id="invoice-number">-</span></p>
        <p class="text-xs text-pro-secondary"><span class="font-semibold">Fecha:</span> <span id="invoice-date">-</span></p>
        <p class="text-xs text-pro-secondary"><span class="font-semibold">ID:</span> <span id="invoice-id">-</span></p>
       </div>
      </div><!-- Datos del Cliente -->
      <div class="mb-7 p-4 bg-gray-50 rounded border border-gray-200">
       <h3 class="font-semibold text-pro-primary mb-3 text-sm uppercase tracking-wide">Información del Cliente</h3>
       <div class="grid grid-cols-2 gap-3 text-xs">
        <p><span class="text-pro-secondary">Nombre Completo:</span> <span id="invoice-client-name" class="font-medium text-pro-primary ml-1">-</span></p>
        <p><span class="text-pro-secondary">DNI / Identificación:</span> <span id="invoice-client-dni" class="font-medium text-pro-primary ml-1">-</span></p>
       </div>
      </div><!-- Tabla de Productos -->
      <div class="mb-7">
       <table class="w-full text-xs">
        <thead>
         <tr class="table-header-pro">
          <th class="text-left py-2.5 px-2">Código</th>
          <th class="text-left py-2.5 px-2">Producto</th>
          <th class="text-center py-2.5 px-2">Cant.</th>
          <th class="text-right py-2.5 px-2">P. Unitario</th>
          <th class="text-center py-2.5 px-2">Desc. %</th>
          <th class="text-right py-2.5 px-2">Total</th>
         </tr>
        </thead>
        <tbody id="invoice-products">
        </tbody>
       </table>
      </div><!-- Totales -->
      <div class="flex justify-end mb-7">
       <div class="w-80 bg-gray-50 rounded p-4 border border-gray-200">
        <div class="flex justify-between py-2 border-b border-gray-300 text-sm"><span class="text-pro-secondary">Subtotal:</span> <span id="invoice-subtotal" class="font-semibold text-pro-primary">$0.00</span>
        </div>
        <div class="flex justify-between py-2 border-b border-gray-300 text-sm"><span class="text-pro-secondary">Descuentos Aplicados:</span> <span id="invoice-discounts" class="font-semibold text-pro-primary">-$0.00</span>
        </div>
        <div class="flex justify-between py-3 text-base mt-2"><span class="font-bold text-pro-primary">TOTAL:</span> <span id="invoice-total" class="font-bold text-pro-primary">$0.00</span>
        </div>
       </div>
      </div><!-- Información de Pago -->
      <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded mb-6 border border-gray-200 text-sm">
       <div>
        <p class="text-xs text-pro-secondary uppercase tracking-wide mb-1">Método de Pago</p>
        <p id="invoice-payment-method" class="font-semibold text-pro-primary">-</p>
       </div>
       <div>
        <p class="text-xs text-pro-secondary uppercase tracking-wide mb-1">Estado del Pago</p><span id="invoice-status" class="inline-flex items-center px-2.5 py-1 rounded text-xs font-semibold bg-green-100 text-green-800"> Pagado </span>
       </div>
      </div><!-- Notas y Comentarios -->
      <div id="invoice-notes" class="hidden p-4 bg-gray-50 rounded border border-gray-200 mb-6">
       <h4 class="font-semibold text-pro-primary mb-2 text-sm uppercase tracking-wide flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
        </svg> Notas Adicionales</h4>
       <div id="invoice-notes-content" class="text-xs text-pro-secondary"></div>
      </div><!-- Footer -->
      <div class="text-center text-xs text-pro-secondary pt-6 border-t-2 border-gray-300">
       <p class="font-semibold">Gracias por confiar en nuestros servicios médicos</p>
       <p class="mt-1">Este documento constituye una representación impresa de una factura electrónica</p>
      </div>
     </div>
    </div>
   </div><!-- Modal Nuevo Cliente -->
   <div id="new-client-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
    <div class="card-professional rounded-md p-6 w-full max-w-2xl max-h-[90%] overflow-y-auto fade-in-pro">
     <div class="flex items-center justify-between mb-5 pb-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-pro-primary flex items-center gap-2">
       <svg class="w-5 h-5 text-pro-secondary" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
       </svg> Registro de Nuevo Cliente</h2><button onclick="closeNewClientModal()" class="text-pro-tertiary hover:text-pro-primary p-2 hover:bg-gray-100 rounded transition-all">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
       </svg></button>
     </div>
     <form id="new-client-form" class="space-y-4">
      <div><label for="client-name" class="block text-xs font-semibold text-pro-secondary uppercase tracking-wide mb-2">Nombre Completo *</label> <input type="text" id="client-name" required class="input-pro w-full rounded px-4 py-2.5 text-sm" placeholder="Ingrese nombre completo del paciente">
      </div>
      <div class="grid grid-cols-2 gap-4">
       <div><label for="client-age" class="block text-xs font-semibold text-pro-secondary uppercase tracking-wide mb-2">Edad *</label> <input type="number" id="client-age" required min="0" max="150" class="input-pro w-full rounded px-4 py-2.5 text-sm" placeholder="Edad">
       </div>
       <div><label for="client-birthdate" class="block text-xs font-semibold text-pro-secondary uppercase tracking-wide mb-2">Fecha de Nacimiento *</label> <input type="date" id="client-birthdate" required class="input-pro w-full rounded px-4 py-2.5 text-sm">
       </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
       <div><label for="client-dni" class="block text-xs font-semibold text-pro-secondary uppercase tracking-wide mb-2">DNI / Identificación *</label> <input type="text" id="client-dni" required class="input-pro w-full rounded px-4 py-2.5 text-sm" placeholder="Número de identificación">
       </div>
       <div><label for="client-gender" class="block text-xs font-semibold text-pro-secondary uppercase tracking-wide mb-2">Género *</label> <select id="client-gender" required class="input-pro w-full rounded px-4 py-2.5 text-sm"> <option value="">Seleccionar...</option> <option value="Masculino">Masculino</option> <option value="Femenino">Femenino</option> <option value="Otro">Otro</option> </select>
       </div>
      </div>
      <div><label for="client-location" class="block text-xs font-semibold text-pro-secondary uppercase tracking-wide mb-2">Ubicación / Dirección *</label> <input type="text" id="client-location" required class="input-pro w-full rounded px-4 py-2.5 text-sm" placeholder="Ciudad, Estado, País">
      </div>
      <div class="grid grid-cols-2 gap-4">
       <div><label for="client-phone" class="block text-xs font-semibold text-pro-secondary uppercase tracking-wide mb-2">Teléfono de Contacto *</label> <input type="tel" id="client-phone" required class="input-pro w-full rounded px-4 py-2.5 text-sm" placeholder="(555) 123-4567">
       </div>
       <div><label for="client-email" class="block text-xs font-semibold text-pro-secondary uppercase tracking-wide mb-2">Correo Electrónico *</label> <input type="email" id="client-email" required class="input-pro w-full rounded px-4 py-2.5 text-sm" placeholder="correo@ejemplo.com">
       </div>
      </div>
      <div class="flex gap-3 pt-4 border-t border-gray-200"><button type="button" onclick="closeNewClientModal()" class="btn-secondary-pro flex-1 py-2.5 rounded text-pro-primary font-medium text-sm"> Cancelar </button> <button type="submit" id="save-client-btn" class="btn-primary-pro flex-1 py-2.5 rounded text-white font-medium text-sm"> Registrar Cliente </button>
      </div>
     </form>
    </div>
   </div><!-- Modal Comentario -->
   <div id="comment-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
    <div class="card-professional rounded-md p-6 w-full max-w-md fade-in-pro">
     <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-200">
      <h2 class="text-base font-semibold text-pro-primary">Agregar Nota al Producto</h2><button onclick="closeCommentModal()" class="text-pro-tertiary hover:text-pro-primary p-2 hover:bg-gray-100 rounded transition-all">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
       </svg></button>
     </div>
     <p id="comment-product-name" class="text-xs text-pro-secondary mb-3 bg-gray-50 px-3 py-2 rounded border border-gray-200">Producto: -</p><textarea id="comment-input" class="input-pro w-full rounded px-4 py-3 h-28 resize-none text-sm" placeholder="Escriba una nota o comentario sobre este producto..."></textarea>
     <div class="flex gap-3 mt-4"><button onclick="closeCommentModal()" class="btn-secondary-pro flex-1 py-2.5 rounded text-pro-primary font-medium text-sm">Cancelar</button> <button onclick="saveComment()" class="btn-primary-pro flex-1 py-2.5 rounded text-white font-medium text-sm">Guardar Nota</button>
     </div>
    </div>
   </div><!-- Modal Método de Pago -->
   <div id="payment-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
    <div class="card-professional rounded-md p-6 w-full max-w-md fade-in-pro">
     <div class="flex items-center justify-between mb-5 pb-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-pro-primary">Configuración de Pago</h2><button onclick="closePaymentModal()" class="text-pro-tertiary hover:text-pro-primary p-2 hover:bg-gray-100 rounded transition-all">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
       </svg></button>
     </div>
     <div class="mb-5"><label class="block text-xs font-semibold text-pro-secondary uppercase tracking-wide mb-3">Método de Pago</label>
      <div class="space-y-2"><label class="flex items-center p-3 border border-gray-300 rounded cursor-pointer hover:bg-gray-50 transition-all payment-option"> <input type="radio" name="payment-method" value="Efectivo" class="w-4 h-4" style="accent-color: #8347be" checked> <span class="ml-3 font-medium text-pro-primary text-sm">Efectivo</span> </label> <label class="flex items-center p-3 border border-gray-300 rounded cursor-pointer hover:bg-gray-50 transition-all payment-option"> <input type="radio" name="payment-method" value="Tarjeta de Crédito" class="w-4 h-4" style="accent-color: #8347be"> <span class="ml-3 font-medium text-pro-primary text-sm">Tarjeta de Crédito</span> </label> <label class="flex items-center p-3 border border-gray-300 rounded cursor-pointer hover:bg-gray-50 transition-all payment-option"> <input type="radio" name="payment-method" value="Tarjeta de Débito" class="w-4 h-4" style="accent-color: #8347be"> <span class="ml-3 font-medium text-pro-primary text-sm">Tarjeta de Débito</span> </label> <label class="flex items-center p-3 border border-gray-300 rounded cursor-pointer hover:bg-gray-50 transition-all payment-option"> <input type="radio" name="payment-method" value="Transferencia Bancaria" class="w-4 h-4" style="accent-color: #8347be"> <span class="ml-3 font-medium text-pro-primary text-sm">Transferencia Bancaria</span> </label>
      </div>
     </div>
     <div class="mb-5"><label class="block text-xs font-semibold text-pro-secondary uppercase tracking-wide mb-3">Estado del Pago</label>
      <div class="flex gap-3"><label class="flex-1 flex items-center justify-center p-3 border-2 border-green-600 rounded cursor-pointer hover:bg-green-50 transition-all bg-green-50"> <input type="radio" name="payment-status" value="Pagado" class="hidden" checked> <span class="font-semibold text-green-700 text-sm">Pagado</span> </label> <label class="flex-1 flex items-center justify-center p-3 border-2 border-gray-300 rounded cursor-pointer hover:bg-gray-50 transition-all"> <input type="radio" name="payment-status" value="Pendiente" class="hidden"> <span class="font-semibold text-pro-primary text-sm">Pendiente</span> </label>
      </div>
     </div>
     <div class="flex gap-3 pt-4 border-t border-gray-200"><button onclick="closePaymentModal()" class="btn-secondary-pro flex-1 py-2.5 rounded text-pro-primary font-medium text-sm">Cancelar</button> <button onclick="confirmPayment()" id="confirm-payment-btn" class="btn-primary-pro flex-1 py-2.5 rounded text-white font-medium text-sm">Confirmar y Generar</button>
     </div>
    </div>
   </div><!-- Toast Notification -->
   <div id="toast" class="hidden fixed bottom-6 right-6 z-50 card-professional rounded p-4 fade-in-pro flex items-center gap-3 shadow-lg">
    <div id="toast-icon" class="w-8 h-8 rounded-full flex items-center justify-center"></div><span id="toast-message" class="font-medium text-pro-primary text-sm"></span>
   </div>
  </div>
  <script>
    // Configuration
    const defaultConfig = {
      clinic_name: 'Clínica Salud Plus',
      clinic_address: 'Av. Principal #123, Ciudad',
      clinic_phone: '(555) 123-4567',
      clinic_email: 'contacto@clinicaplus.com',
      background_color: '#f5f7fa',
      surface_color: '#ffffff',
      text_color: '#1f2937',
      primary_color: '#8347be',
      secondary_color: '#57606a'
    };
    
    let config = { ...defaultConfig };
    
    // Sample Products Data
    const products = [
      { code: 'MED001', name: 'Paracetamol 500mg', description: 'Caja de 20 tabletas analgésicas', price: 85.00, stock: 150 },
      { code: 'MED002', name: 'Ibuprofeno 400mg', description: 'Caja de 10 cápsulas antiinflamatorias', price: 120.00, stock: 80 },
      { code: 'MED003', name: 'Amoxicilina 500mg', description: 'Caja de 21 cápsulas antibióticas', price: 250.00, stock: 45 },
      { code: 'MED004', name: 'Omeprazol 20mg', description: 'Caja de 14 cápsulas para gastritis', price: 180.00, stock: 100 },
      { code: 'MED005', name: 'Loratadina 10mg', description: 'Caja de 10 tabletas antialérgicas', price: 95.00, stock: 120 },
      { code: 'VIT001', name: 'Vitamina C 1000mg', description: 'Frasco de 30 tabletas efervescentes', price: 200.00, stock: 60 },
      { code: 'VIT002', name: 'Complejo B', description: 'Frasco de 60 cápsulas vitamínicas', price: 320.00, stock: 40 },
      { code: 'CUR001', name: 'Vendas Elásticas', description: 'Paquete de 3 vendas de 10cm', price: 75.00, stock: 200 },
      { code: 'CUR002', name: 'Gasas Estériles', description: 'Paquete de 10 gasas 10x10cm', price: 45.00, stock: 300 },
      { code: 'EQU001', name: 'Termómetro Digital', description: 'Termómetro infrarrojo sin contacto', price: 450.00, stock: 25 },
      { code: 'EQU002', name: 'Oxímetro de Pulso', description: 'Medidor de saturación de oxígeno', price: 350.00, stock: 30 },
      { code: 'HIG001', name: 'Alcohol en Gel 500ml', description: 'Gel antibacterial 70% alcohol', price: 65.00, stock: 180 },
      { code: 'HIG002', name: 'Cubrebocas N95', description: 'Caja de 10 mascarillas', price: 280.00, stock: 100 }
    ];
    
    // Exchange rates (base MXN)
    const exchangeRates = {
      MXN: 1,
      USD: 0.058,
      EUR: 0.053,
      INR: 4.85,
      GBP: 0.046
    };
    
    const currencySymbols = {
      MXN: '$',
      USD: '$',
      EUR: '€',
      INR: '₹',
      GBP: '£'
    };
    
    // State
    let cart = [];
    let clients = [];
    let invoices = [];
    let selectedClient = null;
    let currentCurrency = 'MXN';
    let commentProductIndex = null;
    let invoiceCounter = 1;
    
    // Data SDK Handler
    const dataHandler = {
      onDataChanged(data) {
        clients = data.filter(d => d.type === 'client');
        invoices = data.filter(d => d.type === 'invoice');
        
        // Update invoice counter
        if (invoices.length > 0) {
          const maxInvoiceNum = Math.max(...invoices.map(inv => {
            const num = parseInt(inv.invoiceNumber.replace('FAC-', ''));
            return isNaN(num) ? 0 : num;
          }));
          invoiceCounter = maxInvoiceNum + 1;
        }
      }
    };
    
    // Initialize
    async function init() {
      // Initialize Element SDK
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            updateClinicInfo();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              {
                get: () => cfg.background_color || defaultConfig.background_color,
                set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
              },
              {
                get: () => cfg.surface_color || defaultConfig.surface_color,
                set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
              },
              {
                get: () => cfg.text_color || defaultConfig.text_color,
                set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
              },
              {
                get: () => cfg.primary_color || defaultConfig.primary_color,
                set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }
              },
              {
                get: () => cfg.secondary_color || defaultConfig.secondary_color,
                set: (v) => { cfg.secondary_color = v; window.elementSdk.setConfig({ secondary_color: v }); }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['clinic_name', cfg.clinic_name || defaultConfig.clinic_name],
            ['clinic_address', cfg.clinic_address || defaultConfig.clinic_address],
            ['clinic_phone', cfg.clinic_phone || defaultConfig.clinic_phone],
            ['clinic_email', cfg.clinic_email || defaultConfig.clinic_email]
          ])
        });
      }
      
      // Initialize Data SDK
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize data SDK');
        }
      }
      
      // Setup event listeners
      setupEventListeners();
      updateClinicInfo();
    }
    
    function updateClinicInfo() {
      const clinicTitle = document.getElementById('clinic-title');
      const invoiceClinicName = document.getElementById('invoice-clinic-name');
      const invoiceClinicAddress = document.getElementById('invoice-clinic-address');
      const invoiceClinicPhone = document.getElementById('invoice-clinic-phone');
      const invoiceClinicEmail = document.getElementById('invoice-clinic-email');
      
      if (clinicTitle) clinicTitle.textContent = config.clinic_name || defaultConfig.clinic_name;
      if (invoiceClinicName) invoiceClinicName.textContent = config.clinic_name || defaultConfig.clinic_name;
      if (invoiceClinicAddress) invoiceClinicAddress.textContent = config.clinic_address || defaultConfig.clinic_address;
      if (invoiceClinicPhone) invoiceClinicPhone.textContent = `Tel: ${config.clinic_phone || defaultConfig.clinic_phone}`;
      if (invoiceClinicEmail) invoiceClinicEmail.textContent = `Email: ${config.clinic_email || defaultConfig.clinic_email}`;
    }
    
    function setupEventListeners() {
      // Product search
      document.getElementById('product-search').addEventListener('input', (e) => {
        searchProducts(e.target.value);
      });
      
      // Client search
      document.getElementById('client-search').addEventListener('input', (e) => {
        searchClients(e.target.value);
      });
      
      // Currency selector
      document.getElementById('currency-select').addEventListener('change', (e) => {
        currentCurrency = e.target.value;
        document.getElementById('currency-badge').textContent = currentCurrency;
        updateCartDisplay();
      });
      
      // New client form
      document.getElementById('new-client-form').addEventListener('submit', (e) => {
        e.preventDefault();
        saveNewClient();
      });
      
      // Payment options styling
      document.querySelectorAll('.payment-option input').forEach(input => {
        input.addEventListener('change', (e) => {
          document.querySelectorAll('.payment-option').forEach(opt => {
            opt.classList.remove('border-purple-500', 'bg-purple-50');
            opt.classList.add('border-gray-300');
          });
          e.target.closest('.payment-option').classList.remove('border-gray-300');
          e.target.closest('.payment-option').classList.add('border-purple-500', 'bg-purple-50');
        });
      });
      
      // Payment status styling
      document.querySelectorAll('input[name="payment-status"]').forEach(input => {
        input.addEventListener('change', (e) => {
          const labels = document.querySelectorAll('input[name="payment-status"]');
          labels.forEach(l => {
            const label = l.closest('label');
            label.classList.remove('bg-green-50', 'bg-gray-50', 'border-green-600', 'border-gray-300');
            label.classList.add('border-gray-300');
          });
          const label = e.target.closest('label');
          if (e.target.value === 'Pagado') {
            label.classList.remove('border-gray-300');
            label.classList.add('bg-green-50', 'border-green-600');
          } else {
            label.classList.remove('border-gray-300');
            label.classList.add('bg-gray-50', 'border-gray-400');
          }
        });
      });
    }
    
    // Product Functions
    function searchProducts(query) {
      const resultsContainer = document.getElementById('product-results');
      
      if (!query.trim()) {
        resultsContainer.innerHTML = '';
        return;
      }
      
      const filtered = products.filter(p => 
        p.code.toLowerCase().includes(query.toLowerCase()) ||
        p.name.toLowerCase().includes(query.toLowerCase())
      ).slice(0, 5);
      
      if (filtered.length === 0) {
        resultsContainer.innerHTML = '<p class="text-xs text-pro-tertiary text-center py-4">No se encontraron productos</p>';
        return;
      }
      
      resultsContainer.innerHTML = filtered.map(p => `
        <button onclick="addToCart('${p.code}')" class="w-full text-left p-3 rounded hover:bg-gray-50 border border-gray-200 transition-all flex justify-between items-center group">
          <div>
            <p class="font-semibold text-pro-primary text-sm">${p.name}</p>
            <p class="text-xs text-pro-tertiary">${p.code} · Stock: ${p.stock} unidades</p>
          </div>
          <div class="text-right">
            <p class="font-semibold text-pro-primary text-sm">${formatPrice(p.price)}</p>
          </div>
        </button>
      `).join('');
    }
    
    function addToCart(code) {
      const product = products.find(p => p.code === code);
      if (!product) return;
      
      const existingIndex = cart.findIndex(item => item.code === code);
      
      if (existingIndex >= 0) {
        if (cart[existingIndex].quantity < product.stock) {
          cart[existingIndex].quantity++;
        } else {
          showToast('Stock insuficiente', 'error');
          return;
        }
      } else {
        cart.push({
          ...product,
          quantity: 1,
          discount: 0,
          comment: ''
        });
      }
      
      updateCartDisplay();
      showToast(`${product.name} agregado`, 'success');
    }
    
    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartDisplay();
    }
    
    function updateQuantity(index, delta) {
      const item = cart[index];
      const product = products.find(p => p.code === item.code);
      const newQty = item.quantity + delta;
      
      if (newQty <= 0) {
        removeFromCart(index);
        return;
      }
      
      if (newQty > product.stock) {
        showToast('Stock insuficiente', 'error');
        return;
      }
      
      cart[index].quantity = newQty;
      updateCartDisplay();
    }
    
    function updateDiscount(index, value) {
      const discount = Math.max(0, Math.min(100, parseFloat(value) || 0));
      cart[index].discount = discount;
      updateCartDisplay();
    }
    
    function updateCartDisplay() {
      const tableBody = document.getElementById('cart-table');
      
      if (cart.length === 0) {
        tableBody.innerHTML = `
          <tr id="empty-cart-row">
            <td colspan="9" class="py-16 text-center">
              <svg class="w-14 h-14 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
              </svg>
              <p class="text-sm font-medium text-pro-tertiary">No hay productos agregados</p>
              <p class="text-xs text-pro-tertiary mt-1">Utilice el buscador para agregar productos a la factura</p>
            </td>
          </tr>
        `;
        document.getElementById('subtotal').textContent = formatPrice(0);
        document.getElementById('total-discounts').textContent = `-${formatPrice(0)}`;
        document.getElementById('total').textContent = formatPrice(0);
        document.getElementById('checkout-btn').disabled = true;
        return;
      }
      
      let subtotal = 0;
      let totalDiscounts = 0;
      
      tableBody.innerHTML = cart.map((item, index) => {
        const itemSubtotal = item.price * item.quantity;
        const discountAmount = itemSubtotal * (item.discount / 100);
        const itemTotal = itemSubtotal - discountAmount;
        
        subtotal += itemSubtotal;
        totalDiscounts += discountAmount;
        
        return `
          <tr class="table-row-pro border-b border-gray-100">
            <td class="py-3.5 px-3 text-pro-secondary font-mono text-xs">${item.code}</td>
            <td class="py-3.5 px-3">
              <p class="font-medium text-pro-primary text-sm">${item.name}</p>
              ${item.comment ? `<p class="text-xs text-pro-tertiary mt-1">${item.comment}</p>` : ''}
            </td>
            <td class="py-3.5 px-3 hidden md:table-cell text-pro-secondary text-xs">${item.description}</td>
            <td class="py-3.5 px-3">
              <div class="flex items-center justify-center gap-2">
                <button onclick="updateQuantity(${index}, -1)" class="w-7 h-7 rounded bg-gray-100 hover:bg-gray-200 text-pro-primary flex items-center justify-center font-semibold transition-all text-sm">−</button>
                <span class="w-10 text-center font-semibold text-pro-primary text-sm">${item.quantity}</span>
                <button onclick="updateQuantity(${index}, 1)" class="w-7 h-7 rounded bg-gray-100 hover:bg-gray-200 text-pro-primary flex items-center justify-center font-semibold transition-all text-sm">+</button>
              </div>
            </td>
            <td class="py-3.5 px-3 text-right font-medium text-pro-primary text-sm">${formatPrice(item.price)}</td>
            <td class="py-3.5 px-3 text-center hidden lg:table-cell text-pro-secondary text-sm">${item.stock}</td>
            <td class="py-3.5 px-3">
              <input type="number" value="${item.discount}" min="0" max="100" onchange="updateDiscount(${index}, this.value)" class="w-14 text-center input-pro rounded py-1.5 px-2 text-xs font-medium">
            </td>
            <td class="py-3.5 px-3 text-right font-semibold text-pro-primary text-sm">${formatPrice(itemTotal)}</td>
            <td class="py-3.5 px-3">
              <div class="flex items-center justify-center gap-2">
                <button onclick="openCommentModal(${index})" class="w-7 h-7 rounded hover:bg-gray-100 text-pro-tertiary hover:text-pro-primary flex items-center justify-center transition-all" title="Agregar nota">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                  </svg>
                </button>
                <button onclick="removeFromCart(${index})" class="w-7 h-7 rounded hover:bg-red-100 text-pro-tertiary hover:text-red-600 flex items-center justify-center transition-all" title="Eliminar">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      const total = subtotal - totalDiscounts;
      
      document.getElementById('subtotal').textContent = formatPrice(subtotal);
      document.getElementById('total-discounts').textContent = `-${formatPrice(totalDiscounts)}`;
      document.getElementById('total').textContent = formatPrice(total);
      document.getElementById('checkout-btn').disabled = !selectedClient;
    }
    
    // Client Functions
    function searchClients(query) {
      const resultsContainer = document.getElementById('client-results');
      
      if (!query.trim()) {
        resultsContainer.innerHTML = '';
        return;
      }
      
      const filtered = clients.filter(c => 
        c.name.toLowerCase().includes(query.toLowerCase()) ||
        c.dni.toLowerCase().includes(query.toLowerCase())
      ).slice(0, 3);
      
      if (filtered.length === 0) {
        resultsContainer.innerHTML = '<p class="text-xs text-pro-tertiary text-center py-2">No se encontraron clientes registrados</p>';
        return;
      }
      
      resultsContainer.innerHTML = filtered.map(c => `
        <button onclick="selectClient('${c.__backendId}')" class="w-full text-left p-2.5 rounded hover:bg-gray-50 border border-gray-200 transition-all">
          <p class="font-medium text-pro-primary text-sm">${c.name}</p>
          <p class="text-xs text-pro-tertiary">DNI: ${c.dni} · ${c.phone}</p>
        </button>
      `).join('');
    }
    
    function selectClient(backendId) {
      const client = clients.find(c => c.__backendId === backendId);
      if (!client) return;
      
      selectedClient = client;
      
      document.getElementById('selected-client').classList.remove('hidden');
      document.getElementById('selected-client-name').textContent = client.name;
      document.getElementById('selected-client-dni').textContent = `DNI: ${client.dni}`;
      document.getElementById('client-search').value = '';
      document.getElementById('client-results').innerHTML = '';
      
      updateCartDisplay();
      showToast(`Cliente ${client.name} seleccionado`, 'success');
    }
    
    function clearSelectedClient() {
      selectedClient = null;
      document.getElementById('selected-client').classList.add('hidden');
      updateCartDisplay();
    }
    
    function openNewClientModal() {
      document.getElementById('new-client-modal').classList.remove('hidden');
    }
    
    function closeNewClientModal() {
      document.getElementById('new-client-modal').classList.add('hidden');
      document.getElementById('new-client-form').reset();
    }
    
    async function saveNewClient() {
      if (clients.length >= 999) {
        showToast('Límite de clientes alcanzado (999)', 'error');
        return;
      }
      
      const btn = document.getElementById('save-client-btn');
      btn.disabled = true;
      btn.textContent = 'Guardando...';
      
      const newClient = {
        type: 'client',
        name: document.getElementById('client-name').value,
        age: parseInt(document.getElementById('client-age').value),
        birthDate: document.getElementById('client-birthdate').value,
        dni: document.getElementById('client-dni').value,
        location: document.getElementById('client-location').value,
        gender: document.getElementById('client-gender').value,
        phone: document.getElementById('client-phone').value,
        email: document.getElementById('client-email').value,
        createdAt: new Date().toISOString()
      };
      
      if (window.dataSdk) {
        const result = await window.dataSdk.create(newClient);
        if (result.isOk) {
          showToast('Cliente registrado exitosamente', 'success');
          closeNewClientModal();
          
          // Wait for data to update, then select the new client
          setTimeout(() => {
            const createdClient = clients.find(c => c.dni === newClient.dni);
            if (createdClient) {
              selectClient(createdClient.__backendId);
            }
          }, 500);
        } else {
          showToast('Error al guardar cliente', 'error');
        }
      }
      
      btn.disabled = false;
      btn.textContent = 'Registrar Cliente';
    }
    
    // Comment Functions
    function openCommentModal(index) {
      commentProductIndex = index;
      document.getElementById('comment-product-name').textContent = `Producto: ${cart[index].name}`;
      document.getElementById('comment-input').value = cart[index].comment || '';
      document.getElementById('comment-modal').classList.remove('hidden');
    }
    
    function closeCommentModal() {
      document.getElementById('comment-modal').classList.add('hidden');
      commentProductIndex = null;
    }
    
    function saveComment() {
      if (commentProductIndex !== null) {
        cart[commentProductIndex].comment = document.getElementById('comment-input').value;
        updateCartDisplay();
        closeCommentModal();
        showToast('Nota guardada correctamente', 'success');
      }
    }
    
    // Payment Functions
    function processPayment() {
      if (!selectedClient) {
        showToast('Debe seleccionar un cliente', 'error');
        return;
      }
      
      if (cart.length === 0) {
        showToast('El carrito está vacío', 'error');
        return;
      }
      
      document.getElementById('payment-modal').classList.remove('hidden');
    }
    
    function closePaymentModal() {
      document.getElementById('payment-modal').classList.add('hidden');
    }
    
    async function confirmPayment() {
      const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
      const paymentStatus = document.querySelector('input[name="payment-status"]:checked').value;
      
      const btn = document.getElementById('confirm-payment-btn');
      btn.disabled = true;
      btn.textContent = 'Procesando...';
      
      let subtotal = 0;
      let totalDiscounts = 0;
      
      cart.forEach(item => {
        const itemSubtotal = item.price * item.quantity;
        const discountAmount = itemSubtotal * (item.discount / 100);
        subtotal += itemSubtotal;
        totalDiscounts += discountAmount;
      });
      
      const total = subtotal - totalDiscounts;
      
      const invoiceData = {
        type: 'invoice',
        invoiceNumber: `FAC-${String(invoiceCounter).padStart(6, '0')}`,
        invoiceDate: new Date().toISOString(),
        clientName: selectedClient.name,
        clientDni: selectedClient.dni,
        products: JSON.stringify(cart),
        subtotal: subtotal,
        total: total,
        currency: currentCurrency,
        paymentMethod: paymentMethod,
        status: paymentStatus,
        createdAt: new Date().toISOString()
      };
      
      if (window.dataSdk) {
        const result = await window.dataSdk.create(invoiceData);
        if (!result.isOk) {
          showToast('Error al guardar factura', 'error');
          btn.disabled = false;
          btn.textContent = 'Confirmar y Generar';
          return;
        }
      }
      
      // Show invoice
      showInvoice(invoiceData, totalDiscounts);
      
      closePaymentModal();
      btn.disabled = false;
      btn.textContent = 'Confirmar y Generar';
    }
    
    function showInvoice(invoice, discounts) {
      // Update invoice view
      document.getElementById('invoice-number').textContent = invoice.invoiceNumber;
      document.getElementById('invoice-date').textContent = new Date(invoice.invoiceDate).toLocaleDateString('es-MX', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('invoice-id').textContent = `INV-${Date.now().toString(36).toUpperCase()}`;
      
      document.getElementById('invoice-client-name').textContent = invoice.clientName;
      document.getElementById('invoice-client-dni').textContent = invoice.clientDni;
      
      const products = JSON.parse(invoice.products);
      let notesHtml = '';
      
      document.getElementById('invoice-products').innerHTML = products.map(item => {
        const itemSubtotal = item.price * item.quantity;
        const discountAmount = itemSubtotal * (item.discount / 100);
        const itemTotal = itemSubtotal - discountAmount;
        
        if (item.comment) {
          notesHtml += `<p class="mb-1"><strong>${item.name}:</strong> ${item.comment}</p>`;
        }
        
        return `
          <tr class="border-b border-gray-100">
            <td class="py-3 text-pro-secondary font-mono text-xs">${item.code}</td>
            <td class="py-3 font-medium text-pro-primary text-xs">${item.name}</td>
            <td class="py-3 text-center text-xs">${item.quantity}</td>
            <td class="py-3 text-right text-xs">${formatPrice(item.price, invoice.currency)}</td>
            <td class="py-3 text-center text-pro-secondary text-xs">${item.discount}%</td>
            <td class="py-3 text-right font-semibold text-xs">${formatPrice(itemTotal, invoice.currency)}</td>
          </tr>
        `;
      }).join('');
      
      document.getElementById('invoice-subtotal').textContent = formatPrice(invoice.subtotal, invoice.currency);
      document.getElementById('invoice-discounts').textContent = `-${formatPrice(discounts, invoice.currency)}`;
      document.getElementById('invoice-total').textContent = formatPrice(invoice.total, invoice.currency);
      
      document.getElementById('invoice-payment-method').textContent = invoice.paymentMethod;
      
      const statusEl = document.getElementById('invoice-status');
      if (invoice.status === 'Pagado') {
        statusEl.className = 'inline-flex items-center px-2.5 py-1 rounded text-xs font-semibold bg-green-100 text-green-800';
        statusEl.textContent = 'Pagado';
      } else {
        statusEl.className = 'inline-flex items-center px-2.5 py-1 rounded text-xs font-semibold bg-yellow-100 text-yellow-800';
        statusEl.textContent = 'Pendiente';
      }
      
      // Show notes if any
      const notesContainer = document.getElementById('invoice-notes');
      const notesContent = document.getElementById('invoice-notes-content');
      if (notesHtml) {
        notesContainer.classList.remove('hidden');
        notesContent.innerHTML = notesHtml;
      } else {
        notesContainer.classList.add('hidden');
      }
      
      // Switch views
      document.getElementById('pos-view').classList.add('hidden');
      document.getElementById('invoice-view').classList.remove('hidden');
    }
    
    function goBackToPOS() {
      document.getElementById('pos-view').classList.remove('hidden');
      document.getElementById('invoice-view').classList.add('hidden');
    }
    
    function newInvoice() {
      cart = [];
      selectedClient = null;
      document.getElementById('selected-client').classList.add('hidden');
      updateCartDisplay();
      goBackToPOS();
      showToast('Nueva factura iniciada', 'success');
    }
    
    // Utility Functions
    function formatPrice(price, currency = currentCurrency) {
      const convertedPrice = price * exchangeRates[currency];
      const symbol = currencySymbols[currency];
      return `${symbol}${convertedPrice.toFixed(2)}`;
    }
    
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toast-icon');
      const msg = document.getElementById('toast-message');
      
      msg.textContent = message;
      
      if (type === 'success') {
        icon.className = 'w-8 h-8 rounded-full flex items-center justify-center bg-green-600 text-white';
        icon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path></svg>';
      } else if (type === 'error') {
        icon.className = 'w-8 h-8 rounded-full flex items-center justify-center bg-red-600 text-white';
        icon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>';
      } else {
        icon.className = 'w-8 h-8 rounded-full flex items-center justify-center bg-blue-600 text-white';
        icon.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
      }
      
      toast.classList.remove('hidden');
      
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }
    
    // Start app
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bf1608dc26cb3bb',t:'MTc2ODYwNTk3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>